---
- name: Create systemd unit configuration
  template:
    src: systemd_unit.j2
    dest: "/etc/systemd/system/{{ nodejs_app_name }}.service"
  when: (not is_docker) and (nodejs_app_start_script)
  notify:
    - reload systemd

- name: Ensure systemd unit is enabled and restarted
  service:
    name: "{{ nodejs_app_name }}"
    enabled: yes
    state: restarted
  when: (not is_docker) and (nodejs_app_start_script)

- name: Create Supervisor config for Docker containers
  template:
    src: supervisor_nodejs.ini.j2
    dest: "/etc/supervisord.d/{{ nodejs_app_name }}.ini"
    mode: 0644
    owner: root
    group: root
  when: (is_docker) and (nodejs_app_start_script)

- block:

    - name: Copy application configuration file to temporary location in a Vagrant environment
      command: cp '{{ item.src }}' '/tmp/{{ item.src | basename }}'
      with_items:
        - "{{ nodejs_app_config_files }}"

    - name: Replace the strings in the application configuration files
      replace:
        dest: '/tmp/{{ item.0.src | basename }}'
        regexp: '{{ item.1.regexp }}'
        replace: '{{ item.1.replace }}'
      notify: Restart the application systemd unit
      with_subelements:
        - "{{ nodejs_app_config_files }}"
        - changes

    - name: Move application configuration file back to original location in a Vagrant environment
      command: mv '/tmp/{{ item.src | basename }}' '{{ item.src }}'
      with_items:
        - "{{ nodejs_app_config_files }}"

  when: is_vagrant

# If VirtualBox Shared Folders on Windows aren't being used then modify files directly.
- name: Replace the strings in the application configuration files
  replace:
    dest: '{{ item.0.src }}'
    regexp: '{{ item.1.regexp }}'
    replace: '{{ item.1.replace }}'
  notify: Restart the application systemd unit
  with_subelements:
    - "{{ nodejs_app_config_files }}"
    - changes
